#!/usr/bin/env perl
use strict;
use warnings;
use DBI;
use Data::Dumper;
use Dotenv -load;

my $drakkar = DBI->connect(
    sprintf('DBI:Pg:database=%s;host=%s', $ENV{'DRAKKAR_DB_DATABASE'}, $ENV{'DRAKKAR_DB_HOSTNAME'}),
    $ENV{'DRAKKAR_DB_USERNAME'},
    $ENV{'DRAKKAR_DB_PASSWORD'},
);

my $vinland = DBI->connect(
    sprintf('DBI:Pg:database=%s;host=%s', $ENV{'VINLAND_DB_DATABASE'}, $ENV{'VINLAND_DB_HOSTNAME'}),
    $ENV{'VINLAND_DB_USERNAME'},
    $ENV{'VINLAND_DB_PASSWORD'},
);

my $select_human_proteins_sth = $drakkar->prepare('
    SELECT p.type, p.taxon_id, p.accession, p.name, p.description, tn.name AS taxon
    FROM proteins AS p, taxon AS t, taxon_name AS tn
    WHERE p.taxon_id = t.ncbi_taxon_id
    AND t.taxon_id = tn.taxon_id
    AND p.type = \'h\'
    AND tn.name_class = \'scientific name\'
    ORDER BY accession ASC
');

my $select_viral_proteins_sth = $drakkar->prepare('
    SELECT p.type, p.taxon_id, p.accession, i.name, p.description, tn.name AS taxon
    FROM associations AS a, descriptions AS d, interactors AS i, proteins AS p, taxon AS t, taxon_name AS tn
    WHERE p.taxon_id = t.ncbi_taxon_id
      AND t.taxon_id = tn.taxon_id
      AND a.id = d.association_id
      AND (i.id = d.interactor1_id OR i.id = d.interactor2_id)
      AND p.id = i.protein_id
      AND a.state = \'curated\'
      AND d.deleted_at IS NULL
      AND p.type=\'v\'
      AND tn.name_class = \'scientific name\'
    GROUP BY p.type, p.taxon_id, p.accession, i.name, p.description, tn.name
    ORDER BY p.accession ASC
');

my @proteins = ();

$select_human_proteins_sth->execute;

while (my $protein = $select_human_proteins_sth->fetchrow_hashref) {
    push(@proteins, [
        $protein->{'type'},
        $protein->{'taxon_id'},
        $protein->{'accession'},
        $protein->{'name'},
        $protein->{'description'},
        join(' ', (
            $protein->{'accession'},
            $protein->{'name'},
            $protein->{'description'},
            $protein->{'taxon'},
        )),
    ]);
}

$select_human_proteins_sth->finish;

$select_viral_proteins_sth->execute;

while (my $protein = $select_viral_proteins_sth->fetchrow_hashref) {
    push(@proteins, [
        $protein->{'type'},
        $protein->{'taxon_id'},
        $protein->{'accession'},
        $protein->{'name'},
        $protein->{'description'},
        join(' ', (
            $protein->{'accession'},
            $protein->{'name'},
            $protein->{'description'},
            $protein->{'taxon'},
        )),
    ]);
}

foreach my $protein (@proteins) {
    print join("\t", @{$protein}) . "\n"
}

#$select_viral_proteins_sth->finish;
#
#$vinland->do('COPY proteins(type, ncbi_taxon_id, accession, name, description, search) FROM STDIN');
#
#$vinland->pg_putcopydata(join("\t", @{$_}) . "\n") foreach (@proteins);
#
#$vinland->pg_putcopyend();
